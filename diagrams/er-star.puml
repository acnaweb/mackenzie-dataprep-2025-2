@startuml
' =========================
' ER — E-commerce Omnichannel (Gold + ponte com Silver)
' =========================
hide circle
skinparam linetype ortho
skinparam class {
  BackgroundColor White
  BorderColor #888
}

' ==========
' DIMENSÕES
' ==========
entity "dim_customer" as dim_customer {
  * customer_id : STRING <<PK>>
  --
  full_name : STRING
  email : STRING
  phone : STRING
  city : STRING
  state : STRING
  region : STRING
  created_at : TIMESTAMP
}

entity "dim_product" as dim_product {
  * product_id : STRING <<PK>>
  --
  sku : STRING
  product_name : STRING
  category : STRING
  current_price_brl : NUMERIC
  updated_at : TIMESTAMP
}

' Dimensão operacional (cabeçalho do pedido), derivada de stg_orders (Silver)
entity "dim_order" as dim_order {
  * order_id : STRING <<PK>>
  --
  customer_id : STRING <<FK dim_customer>>
  order_ts : TIMESTAMP
  order_date : DATE
  channel : STRING       ' ex.: app, web, pos
  amount_brl : NUMERIC   ' total convertido via FX
}

' ======
' FATOS
' ======
entity "fact_order_item" as fact_order_item {
  * order_id : STRING <<FK dim_order>>
  * product_id : STRING <<FK dim_product>>
  --
  customer_id : STRING <<FK dim_customer>>
  order_ts : TIMESTAMP
  channel : STRING
  quantity : INT64
  unit_price : NUMERIC
  gross_item_amount : NUMERIC
  order_amount_brl : NUMERIC
}

entity "fact_payment" as fact_payment {
  * payment_id : STRING <<PK>>
  --
  order_id : STRING <<FK dim_order>>
  method : STRING        ' card, pix, cash, boleto
  status : STRING        ' authorized, captured, refunded
  paid_amount_brl : NUMERIC
  paid_at : TIMESTAMP
}

entity "fact_order_daily" as fact_order_daily {
  * order_date : DATE
  * channel : STRING
  --
  orders : INT64
  revenue_brl : NUMERIC
  unique_customers : INT64
}

' =====================
' RELACIONAMENTOS (PK/FK)
' =====================
' Clientes → Pedidos
dim_customer ||--o{ dim_order : "customer_id"

' Pedidos → Itens / Pagamentos
dim_order ||--o{ fact_order_item : "order_id"
dim_order ||--o{ fact_payment : "order_id"

' Produtos → Itens
dim_product ||--o{ fact_order_item : "product_id"

' Clientes → Itens (redundante, guard rail analítico)
dim_customer ||--o{ fact_order_item : "customer_id"

' Agregação diária (derivado de pedidos/itens)
' Representamos como associação não-estrita (traço pontilhado)
fact_order_item ..> fact_order_daily : "aggregate by date, channel"
dim_order ..> fact_order_daily : "source for daily rollups"

@enduml
