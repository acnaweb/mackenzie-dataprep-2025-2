@startuml
' ==============
' ER - RAW SEEDS
' ==============
hide circle
skinparam linetype ortho
skinparam class {
  BackgroundColor White
  BorderColor #888
}

' ===== Clientes / Geo =====
entity "raw_customers" as raw_customers {
  * customer_id : STRING <<PK?>>
  --
  full_name : STRING
  email : STRING
  phone : STRING
  zipcode : STRING
  created_at : TIMESTAMP
}

entity "raw_geo_zipcode" as raw_geo_zipcode {
  * zipcode : STRING <<PK>>
  --
  city : STRING
  state : STRING
  region : STRING
}

' Ligação direta (zipcode)
raw_geo_zipcode ||--o{ raw_customers : "zipcode"

' ===== Produtos / FX =====
entity "raw_products" as raw_products {
  * product_id : STRING <<PK>>
  --
  sku : STRING
  name : STRING
  category : STRING
  price : NUMERIC
  currency : STRING
  updated_at : TIMESTAMP
}

entity "raw_fx_rates" as raw_fx_rates {
  * rate_date : DATE <<PK>>
  * currency : STRING <<PK>>
  --
  rate_to_brl : NUMERIC
}

' Ligação potencial (depende de data/currency)
raw_fx_rates .. raw_products : "rate_date = DATE(updated_at)\n+ currency"

' ===== Pedidos por canal =====
entity "raw_orders_app" as raw_orders_app {
  * order_id : STRING <<PK?>>
  --
  cust_id : STRING
  order_ts : TIMESTAMP
  total_amount : FLOAT64
  currency : STRING
}

entity "raw_orders_web" as raw_orders_web {
  * order_code : STRING <<PK?>>
  --
  customer_id : STRING
  order_datetime : STRING
  gross_amount : NUMERIC
  currency : STRING
}

entity "raw_orders_pos" as raw_orders_pos {
  * pos_order_id : STRING <<PK?>>
  --
  loyalty_customer : STRING
  order_date : DATE
  amount : NUMERIC
  currency : STRING
}

' FX para pedidos (potencial, via data/currency)
raw_fx_rates .. raw_orders_app : "DATE(order_ts), currency"
raw_fx_rates .. raw_orders_web : "DATE(PARSE_TS(order_datetime)), currency"
raw_fx_rates .. raw_orders_pos : "order_date, currency"

' ===== Itens de pedido =====
entity "raw_order_items_app" as raw_order_items_app {
  * order_id : STRING
  --
  product : STRING
  qty : INT64
  unit_price : NUMERIC
}

entity "raw_order_items_web" as raw_order_items_web {
  * order_code : STRING
  --
  product_id : STRING
  quantity : INT64
  price : NUMERIC
}

entity "raw_order_items_pos" as raw_order_items_pos {
  * pos_order_id : STRING
  --
  sku : STRING
  quantity : INT64
  price : NUMERIC
}

' Ligações diretas por chave de pedido (mesmo nome)
raw_orders_app ||--o{ raw_order_items_app : "order_id"
raw_orders_web ||--o{ raw_order_items_web : "order_code"
raw_orders_pos ||--o{ raw_order_items_pos : "pos_order_id"

' Ligações produto (heterogêneo)
raw_products ||..o{ raw_order_items_app : "product = product_id (mapeamento)"
raw_products ||--o{ raw_order_items_web : "product_id"
raw_products ||..o{ raw_order_items_pos : "sku (via SKU)"

' ===== Pagamentos =====
entity "raw_payments" as raw_payments {
  * payment_id : STRING <<PK>>
  --
  order_ref : STRING
  method : STRING
  status : STRING
  paid_amount : NUMERIC
  currency : STRING
  paid_at : TIMESTAMP
}

' Referência polimórfica: pode apontar para qualquer canal (mapeamento necessário)
raw_payments .. raw_orders_app : "order_ref ↔ order_id"
raw_payments .. raw_orders_web : "order_ref ↔ order_code"
raw_payments .. raw_orders_pos : "order_ref ↔ pos_order_id"

' FX para pagamentos (potencial, via data/currency)
raw_fx_rates .. raw_payments : "rate_date = DATE(paid_at), currency"

' ===== Tráfego / Marketing =====
entity "raw_events_web" as raw_events_web {
  * event_id : STRING <<PK>>
  --
  customer_id : STRING
  event_type : STRING
  event_ts : TIMESTAMP
  session_id : STRING
}

entity "raw_marketing_clicks" as raw_marketing_clicks {
  * click_id : STRING <<PK>>
  --
  customer_email : STRING
  channel : STRING
  campaign : STRING
  clicked_at : TIMESTAMP
}

' Ligações de audiência
raw_customers ||--o{ raw_events_web : "customer_id"
raw_customers ||..o{ raw_marketing_clicks : "LOWER(email) = LOWER(customer_email)"

' ===== Notas Didáticas =====
note top of raw_orders_app
Chaves e nomes heterogêneos:
- Cliente: cust_id
- Pedido: order_id
- Data: order_ts (TIMESTAMP)
end note

note top of raw_orders_web
Chaves e tipos heterogêneos:
- Pedido: order_code
- Data: order_datetime (STRING)
end note

note right of raw_order_items_pos
Produto por SKU (não product_id).
Requer mapeamento para raw_products.sku.
end note

@enduml
